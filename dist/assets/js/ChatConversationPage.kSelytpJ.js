var e=(e,a,t)=>new Promise(((s,i)=>{var r=e=>{try{c(t.next(e))}catch(a){i(a)}},n=e=>{try{c(t.throw(e))}catch(a){i(a)}},c=e=>e.done?s(e.value):Promise.resolve(e.value).then(r,n);c((t=t.apply(e,a)).next())}));import{j as a}from"./vendor-bootstrap.BZxWRyST.js";import{r as t}from"./vendor-react.CSr-5IoM.js";import{u as s}from"./vendor-redux.rUoA4kI-.js";import{c as i}from"./chatService.ZAEw35NS.js";import{T as r}from"./index.Rs0UfOkt.js";import{c as n,u as c}from"./vendor-routing.Dz6WPNpl.js";const o=()=>{const{chatHeadId:o}=n(),l=c(),d=s((e=>e.auth.user)),[h,m]=t.useState(null),[u,g]=t.useState([]),[v,x]=t.useState(""),[j,f]=t.useState(!0),[N,p]=t.useState(!1),[b,w]=t.useState(null),_=t.useRef(null),S=t.useRef(null);t.useEffect((()=>{o&&(null==d?void 0:d.id)&&y()}),[o,d]);const y=()=>e(void 0,null,(function*(){try{f(!0),w(null);const[e,a]=yield Promise.all([i.getChatHeads(),i.getChatMessages(o)]);if(null==e?void 0:e.data){const a=e.data.find((e=>e.id.toString()===o));if(!a)throw new Error("Conversation not found");m(a)}if(null==a?void 0:a.data){const e=a.data.sort(((e,a)=>new Date(e.created_at).getTime()-new Date(a.created_at).getTime()));g(e),setTimeout((()=>D()),100)}}catch(e){const a=e instanceof Error?e.message:"Failed to load conversation";w(a),r.error("Failed to load conversation")}finally{f(!1)}})),D=()=>{S.current&&(S.current.scrollTop=S.current.scrollHeight)},T=()=>e(void 0,null,(function*(){if(v.trim()&&!N&&h&&(null==d?void 0:d.id))try{p(!0);const e=d.id.toString()===h.customer_id?h.product_owner_id:h.customer_id;yield i.sendMessage({chat_head_id:h.id.toString(),sender_id:d.id.toString(),receiver_id:e,body:v.trim()}),x("");const a=yield i.getChatMessages(o);if(null==a?void 0:a.data){const e=a.data.sort(((e,a)=>new Date(e.created_at).getTime()-new Date(a.created_at).getTime()));g(e),setTimeout((()=>D()),100)}r.success("Message sent")}catch(e){r.error("Failed to send message")}finally{p(!1)}})),k=()=>{if(!h||!(null==d?void 0:d.id))return"Unknown User";return d.id.toString()===h.customer_id?h.product_owner_name||"Unknown User":h.customer_name||"Unknown User"},C=e=>{const a=new Date(e),t=new Date,s=Math.floor((t.getTime()-a.getTime())/6e4);if(s<1)return"Just now";if(s<60)return`${s}m ago`;const i=Math.floor(s/60);if(i<24)return`${i}h ago`;const r=a.toDateString()===t.toDateString(),n=a.toDateString()===new Date(t.getTime()-864e5).toDateString();return r?a.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):n?`Yesterday ${a.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}`:a.toLocaleDateString()};return j?a.jsxs("div",{className:"chat-conversation-page",children:[a.jsxs("div",{className:"chat-header",children:[a.jsx("button",{onClick:()=>l("/account/chat"),className:"chat-back-btn",children:a.jsx("i",{className:"bi-arrow-left"})}),a.jsx("div",{className:"chat-header-info",children:a.jsx("h3",{className:"chat-user-name",children:"Loading..."})})]}),a.jsxs("div",{className:"chat-loading",children:[a.jsx("div",{className:"spinner-border text-primary",role:"status"}),a.jsx("p",{children:"Loading conversation..."})]})]}):b||!h?a.jsxs("div",{className:"chat-conversation-page",children:[a.jsxs("div",{className:"chat-header",children:[a.jsx("button",{onClick:()=>l("/account/chat"),className:"chat-back-btn",children:a.jsx("i",{className:"bi-arrow-left"})}),a.jsx("div",{className:"chat-header-info",children:a.jsx("h3",{className:"chat-user-name",children:"Error"})})]}),a.jsxs("div",{className:"chat-error",children:[a.jsx("i",{className:"bi-exclamation-triangle"}),a.jsx("p",{children:b||"Conversation not found"}),a.jsx("button",{onClick:()=>l("/account/chat"),className:"btn btn-primary",children:"Back to Messages"})]})]}):a.jsxs("div",{className:"chat-conversation-page",children:[a.jsxs("div",{className:"chat-header",children:[a.jsx("button",{onClick:()=>l("/account/chat"),className:"chat-back-btn",children:a.jsx("i",{className:"bi-arrow-left"})}),a.jsxs("div",{className:"chat-header-info",children:[a.jsx("h3",{className:"chat-user-name",children:k()}),h.product_name&&a.jsx("span",{className:"chat-product-name",children:h.product_name})]}),a.jsx("button",{onClick:y,className:"chat-refresh-btn",disabled:j,children:a.jsx("i",{className:"bi-arrow-clockwise"})})]}),a.jsx("div",{className:"chat-messages-area",ref:S,children:0===u.length?a.jsxs("div",{className:"chat-empty",children:[a.jsx("i",{className:"bi-chat-heart"}),a.jsxs("p",{children:["Start the conversation with ",k()]})]}):a.jsxs("div",{className:"chat-messages-list",children:[u.map(((e,t)=>{var s;const i=e.sender_id===(null==(s=null==d?void 0:d.id)?void 0:s.toString()),r=0===t||new Date(e.created_at).getTime()-new Date(u[t-1].created_at).getTime()>3e5;return a.jsxs("div",{className:"message-wrapper",children:[r&&a.jsx("div",{className:"message-timestamp",children:C(e.created_at)}),a.jsxs("div",{className:"message-bubble "+(i?"sent":"received"),children:[a.jsx("div",{className:"message-text",children:e.body}),a.jsx("div",{className:"message-time",children:new Date(e.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})]},e.id)})),a.jsx("div",{ref:_})]})}),a.jsx("div",{className:"chat-input-area",children:a.jsxs("div",{className:"chat-input-wrapper",children:[a.jsx("textarea",{className:"chat-input",placeholder:`Message ${k()}...`,value:v,onChange:e=>{x(e.target.value);const a=e.target;a.style.height="auto",a.style.height=`${Math.min(a.scrollHeight,120)}px`},onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),T())},disabled:N,rows:1}),a.jsx("button",{className:"chat-send-btn",onClick:T,disabled:!v.trim()||N,children:N?a.jsx("i",{className:"bi-hourglass-split"}):a.jsx("i",{className:"bi-send-fill"})})]})})]})};export{o as default};
